variables:
    DOCKER_DRIVER: overlay
    CI_REGISTRY_IMAGE_WITH_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME"

stages:
  - build

build:docker-image:
    image: docker:latest
    stage: build
    services:
      - docker:dind
    script:
      - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
      - docker build -t $CI_REGISTRY_IMAGE_WITH_TAG --no-cache=true .
      - docker push $CI_REGISTRY_IMAGE_WITH_TAG
    only:
      - master
    tags:
      - docker
